# -*- coding: utf-8 -*-
import streamlit as st
import cohere
import json
import re

# Use a secrets.toml file to store your API key
# Example secrets.toml:
# COHERE_API_KEY = "your_cohere_api_key_here"
try:
    co = cohere.Client(st.secrets["COHERE_API_KEY"])
except Exception as e:
    st.error("Cohere API key not found. Please add it to your Streamlit secrets.")
    st.stop()


# --- Static Lists from Thai NCSA ---
# These lists contain specific Thai entities for a preliminary, high-priority classification.
# The matching logic will check against these lists first before using the AI model.
# The order of checking is CII -> REG -> GOV. The first match found determines the classification.
NCSA_CII = [
    "กรมการปกครอง", "กรมการแพทย์", "กรมการแพทย์แผนไทยและการแพทย์ทางเลือก", "กรมควบคุมโรค",
    "กรมป้องกันและบรรเทาสาธารณภัย", "กรมวิทยาศาสตร์การแพทย์", "กรมสนับสนุนบริการสุขภาพ", "กรมสุขภาพจิต",
    "กรมอนามัย", "กรมอุตุนิยมวิทยา", "กองการบินทหารเรือ", "กองทะเบียนประวัติอาชญากร", "กองทัพบก",
    "กองทัพเรือ", "กองทัพอากาศ", "กองบัญชาการกองทัพไทย", "กองอำนวยการรักษาความมั่นคงภายในราชอาณาจักร",
    "การท่าเรือแห่งประเทศไทย", "การท่าอากาศยานอู่ตะเภา", "การประปาส่วนภูมิภาค", "การไฟฟ้านครหลวง",
    "การไฟฟ้าฝ่ายผลิตแห่งประเทศไทย", "การไฟฟ้าส่วนภูมิภาค", "การรถไฟฟ้าขนส่งมวลชนแห่งประเทศไทย",
    "การรถไฟแห่งประเทศไทย", "ตลาดหลักทรัพย์แห่งประเทศไทย", "ธนาคารกรุงเทพ", "ธนาคารกรุงไทย",
    "ธนาคารกรุงศรีอยุธยา", "ธนาคารกสิกรไทย", "ธนาคารทหารไทยธนชาต", "ธนาคารไทยพาณิชย์",
    "ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร", "ธนาคารแห่งประเทศไทย", "ธนาคารออมสิน",
    "บริษัท การบินกรุงเทพ จำกัด (มหาชน)", "บริษัท ดับบลิวเอฟเอสพีจีคาร์โก้ จำกัด",
    "บริษัท ตลาดสัญญาซื้อขายล่วงหน้า (ประเทศไทย) จำกัด (มหาชน)", "บริษัท ทริปเปิลที บรอดแบนด์ จำกัด (มหาชน)",
    "บริษัท ทรู มูฟ เอช ยูนิเวอร์แซล คอมมิวนิเคชั่น จำกัด", "บริษัท ทรู อินเทอร์เน็ต คอร์ปอเรชั่น จำกัด",
    "บริษัท ท่าอากาศยานไทย จำกัด (มหาชน)", "บริษัท โทรคมนาคมแห่งชาติ จำกัด (มหาชน)",
    "บริษัท ไทยเวียตเจ็ทแอร์ จำกัด", "บริษัท เนชั่นแนล ไอทีเอ็มเอ๊กซ์ จำกัด", "บริษัท ปตท. จำกัด (มหาชน)",
    "บริษัท รถไฟฟ้า ร.ฟ.ท. จำกัด", "บริษัท ระบบขนส่งมวลชนกรุงเทพ จำกัด (มหาชน)",
    "บริษัท วิทยุการบินแห่งประเทศไทย จำกัด", "บริษัท ศูนย์รับฝากหลักทรัพย์ (ประเทศไทย) จำกัด",
    "บริษัท สายการบินนกแอร์ จำกัด (มหาชน)", "บริษัท สำนักหักบัญชี (ประเทศไทย) จำกัด",
    "บริษัท เอซี เอวิเอชั่น จำกัด", "บริษัท เอ็มเจ็ท จำกัด", "บริษัท แอดวานซ์ ไวร์เลส เน็ทเวอร์ค จำกัด",
    "บริษัท แอ็ดวานซ์ เอวิเอชั่น เจ็ท จำกัด",
    "ศูนย์เทคโนโลยีสารสนเทศกลาง สำนักงานเทคโนโลยีสารสนเทศและการสื่อสาร สำนักงานตำรวจแห่งชาติ",
    "ศูนย์เทคโนโลยีสารสนเทศและการสื่อสาร กรมชลประทาน",
    "ศูนย์เทคโนโลยีสารสนเทศและการสื่อสาร สำนักงานปลัดกระทรวงสาธารณสุข", "สำนักข่าวกรองแห่งชาติ",
    "สำนักงานเขตสุขภาพที่ 5", "สำนักงานคณะกรรมการกำกับกิจการพลังงาน", "สำนักงานคณะกรรรมการอาหารและยา",
    "สำนักงานตรวจคนเข้าเมือง", "สำนักงานปรมาณูเพื่อสันติ", "สำนักงานปลัดกระทรวงกลาโหม",
    "สำนักงานปลัดกระทรวงการคลัง", "สำนักงานพัฒนารัฐบาลดิจิทัล (องค์การมหาชน)",
    "สำนักงานสภาความมั่นคงแห่งชาติ", "สำนักงานหลักประกันสุขภาพแห่งชาติ (สปสช.)",
    "สำนักบริหารจัดการน้ำและอุทกวิทยา", "สำนักสุขภาพดิจิทัล สำนักงานปลัดกระทรวงสาธารณสุข",
    "องค์การเภสัชกรรม"
]
NCSA_REG = [
    "กรมการขนส่งทางราง", "กรมการปกครอง", "กรมชลประทาน", "กรมศุลกากร", "กระทรวงการคลัง",
    "กระทรวงพลังงาน", "การประปาส่วนภูมิภาค", "ธนาคารแห่งประเทศไทย",
    "สำนักงานการบินพลเรือนแห่งประเทศไทย", "สำนักงานคณะกรรมการกำกับหลักทรัพย์และตลาดหลักทรัพย์",
    "สำนักงานคณะกรรมการกิจการกระจายเสียง กิจการโทรทัศน์ และกิจการโทรคมนาคมแห่งชาติ",
    "สำนักงานคณะกรรรมการอาหารและยา", "สำนักงานตำรวจแห่งชาติ", "สำนักงานปรมาณูเพื่อสันติ",
    "สำนักงานปลัดกระทรวงกลาโหม", "สำนักงานปลัดกระทรวงคมนาคม", "สำนักงานปลัดกระทรวงสาธารณสุข",
    "สำนักงานพัฒนารัฐบาลดิจิทัล (องค์การมหาชน)", "สำนักงานสภาความมั่นคงแห่งชาติ"
]
NCSA_GOV = [
    "กรมการกงสุล", "กรมการขนส่งทางบก", "กรมการข้าว", "มหาวิทยาลัยเกษตรศาสตร์", "กระทรวงศึกษาธิการ",
] + [
    "กรมการค้าต่างประเทศ","กรมการค้าภายใน","กรมการจัดหางาน","กรมการท่องเที่ยว","กรมการเปลี่ยนแปลงสภาพภูมิอากาศและสิ่งแวดล้อม",
    "กรมการพัฒนาชุมชน","กรมการศาสนา","กรมกิจการเด็กและเยาวชน","กรมกิจการผู้สูงอายุ","กรมกิจการสตรีและสถาบันครอบครัว",
    "กรมควบคุมมลพิษ","กรมความร่วมมือระหว่างประเทศ","กรมคุ้มครองสิทธิและเสรีภาพ","กรมคุมประพฤติ","กรมเจรจาการค้าระหว่างประเทศ",
    "กรมเจ้าท่า","กรมเชื้อเพลิงธรรมชาติ","กรมตรวจบัญชีสหกรณ์","กรมทรัพย์สินทางปัญญา","กรมทรัพยากรทางทะเลและชายฝั่ง",
    "กรมทรัพยากรธรณี","กรมทรัพยากรน้ำ","กรมทรัพยากรน้ำบาดาล","กรมทางหลวง","กรมทางหลวงชนบท","กรมท่าอากาศยาน",
    "กรมที่ดิน","กรมธนารักษ์","กรมธุรกิจพลังงาน","กรมบังคับคดี","กรมบัญชีกลาง","กรมประชาสัมพันธ์","กรมประมง","กรมปศุสัตว์",
    "กรมป่าไม้","กรมฝนหลวงและการบินเกษตร","กรมพลศึกษา","กรมพัฒนาที่ดิน","กรมพัฒนาธุรกิจการค้า","กรมพัฒนาฝีมือแรงงาน",
    "กรมพัฒนาพลังงานทดแทนและอนุรักษ์พลังงาน","กรมพัฒนาสังคมและสวัสดิการ","กรมพิธีการทูต","กรมพินิจและคุ้มครองเด็กและเยาวชน",
    "กรมยุโรป","กรมโยธาธิการและผังเมือง","กรมราชทัณฑ์","กรมโรงงานอุตสาหกรรม","กรมวิชาการเกษตร","กรมวิทยาศาสตร์บริการ",
    "กรมศิลปากร","กรมเศรษฐกิจระหว่างประเทศ","กรมส่งเสริมการเกษตร","กรมส่งเสริมการค้าระหว่างประเทศ",
    "กรมส่งเสริมการปกครองท้องถิ่น","กรมส่งเสริมและพัฒนาคุณภาพชีวิตคนพิการ","กรมส่งเสริมวัฒนธรรม","กรมส่งเสริมสหกรณ์",
    "กรมส่งเสริมอุตสาหกรรม","กรมสนธิสัญญาและกฎหมาย","กรมสรรพสามิต","กรมสรรพากร","กรมสวัสดิการและคุ้มครองแรงงาน",
    "กรมสอบสวนคดีพิเศษ","กรมสารนิเทศ","กรมหม่อนไหม","กรมองค์การระหว่างประเทศ","กรมอเมริกาและแปซิฟิกใต้","กรมอาเซียน",
    "กรมอุตสาหกรรมพื้นฐานและการเหมืองแร่","กรมอุทยานแห่งชาติ สัตว์ป่า และพันธุ์พืช","กรมเอเชียตะวันออก",
    "กรมเอเชียใต้ ตะวันออกกลาง และแอฟริกา","กระทรวงการต่างประเทศ","กระทรวงการท่องเที่ยวและกีฬา",
    "กระทรวงการพัฒนาสังคมและความมั่นคงของมนุษย์","กระทรวงการอุดมศึกษา วิทยาศาสตร์ วิจัยและนวัตกรรม","กระทรวงเกษตรและสหกรณ์",
    "กระทรวงดิจิทัลเพื่อเศรษฐกิจและสังคม","กระทรวงทรัพยากรธรรมชาติและสิ่งแวดล้อม","กระทรวงพาณิชย์","กระทรวงมหาดไทย",
    "กระทรวงยุติธรรม","กระทรวงแรงงาน","กระทรวงวัฒนธรรม","กระทรวงศึกษาธิการ","กระทรวงอุตสาหกรรม",
    "กองทุนการออมแห่งชาติ","กองทุนบำเหน็จบำนาญข้าราชการ","กองทุนพัฒนาสื่อปลอดภัยและสร้างสรรค์",
    "กองทุนสนับสนุนการสร้างเสริมสุขภาพ","การกีฬาแห่งประเทศไทย","การเคหะแห่งชาติ","การท่องเที่ยวแห่งประเทศไทย",
    "การทางพิเศษแห่งประเทศไทย","การนิคมอุตสาหกรรมแห่งประเทศไทย","การประปานครหลวง","การยาสูบแห่งประเทศไทย","คุรุสภา",
    "จุฬาลงกรณ์มหาวิทยาลัย","ธนาคารพัฒนาวิสาหกิจขนาดกลางและขนาดย่อมแห่งประเทศไทย","ธนาคารเพื่อการส่งออกและนำเข้าแห่งประเทศไทย",
    "ธนาคารอาคารสงเคราะห์","ธนาคารอิสลามแห่งประเทศไทย","บรรษัทประกันสินเชื่ออุตสาหกรรมขนาดย่อม","บริษัท ขนส่ง จำกัด",
    "บริษัท ธนารักษ์พัฒนาสินทรัพย์ จำกัด","บริษัท บริหารสินทรัพย์ ธนาคารอิสลามแห่งประเทศไทย จำกัด",
    "บริษัท ไปรษณีย์ไทย จำกัด","บริษัท โรงแรมท่าอากาศยานสุวรรณภูมิ จำกัด","บริษัท สหโรงแรมไทยและท่องเที่ยว จำกัด",
    "บริษัท อสมท จำกัด (มหาชน)","บริษัท อู่กรุงเทพ จำกัด","มหาวิทยาลัยการกีฬาแห่งชาติ","มหาวิทยาลัยกาฬสินธุ์",
    "มหาวิทยาลัยขอนแก่น","มหาวิทยาลัยเชียงใหม่","มหาวิทยาลัยทักษิณ","มหาวิทยาลัยเทคโนโลยีพระจอมเกล้าธนบุรี",
    "มหาวิทยาลัยเทคโนโลยีพระจอมเกล้าพระนครเหนือ","มหาวิทยาลัยเทคโนโลยีราชมงคลกรุงเทพ","มหาวิทยาลัยเทคโนโลยีราชมงคลตะวันออก",
    "มหาวิทยาลัยเทคโนโลยีราชมงคลธัญบุรี","มหาวิทยาลัยเทคโนโลยีราชมงคลพระนคร","มหาวิทยาลัยเทคโนโลยีราชมงคลรัตนโกสินทร์",
    "มหาวิทยาลัยเทคโนโลยีราชมงคลล้านนา","มหาวิทยาลัยเทคโนโลยีราชมงคลศรีวิชัย","มหาวิทยาลัยเทคโนโลยีราชมงคลสุวรรณภูมิ",
    "มหาวิทยาลัยเทคโนโลยีราชมงคลอีสาน","มหาวิทยาลัยเทคโนโลยีสุรนารี","มหาวิทยาลัยธรรมศาสตร์","มหาวิทยาลัยนครพนม",
    "มหาวิทยาลัยนราธิวาสราชนครินทร์","มหาวิทยาลัยนเรศวร","มหาวิทยาลัยนวมินทราธิราช","มหาวิทยาลัยบูรพา","มหาวิทยาลัยพะเยา",
    "มหาวิทยาลัยมหาจุฬาลงกรณราชวิทยาลัย","มหาวิทยาลัยมหามกุฎราชวิทยาลัย","มหาวิทยาลัยมหาสารคาม","มหาวิทยาลัยมหิดล",
    "มหาวิทยาลัยแม่โจ้","มหาวิทยาลัยแม่ฟ้าหลวง","มหาวิทยาลัยราชภัฏกาญจนบุรี","มหาวิทยาลัยราชภัฏกำแพงเพชร",
    "มหาวิทยาลัยราชภัฏจันทรเกษม","มหาวิทยาลัยราชภัฏชัยภูมิ","มหาวิทยาลัยราชภัฏเชียงราย","มหาวิทยาลัยราชภัฏเชียงใหม่",
    "มหาวิทยาลัยราชภัฏเทพสตรี","มหาวิทยาลัยราชภัฏธนบุรี","มหาวิทยาลัยราชภัฏนครปฐม","มหาวิทยาลัยราชภัฏนครราชสีมา",
    "มหาวิทยาลัยราชภัฏนครศรีธรรมราช","มหาวิทยาลัยราชภัฏนครสวรรค์","มหาวิทยาลัยราชภัฏบ้านสมเด็จเจ้าพระยา",
    "มหาวิทยาลัยราชภัฏบุรีรัมย์","มหาวิทยาลัยราชภัฏพระนคร","มหาวิทยาลัยราชภัฏพระนครศรีอยุธยา","มหาวิทยาลัยราชภัฏพิบูลสงคราม",
    "มหาวิทยาลัยราชภัฏเพชรบุรี","มหาวิทยาลัยราชภัฏเพชรบูรณ์","มหาวิทยาลัยราชภัฏภูเก็ต","มหาวิทยาลัยราชภัฏมหาสารคาม",
    "มหาวิทยาลัยราชภัฏยะลา","มหาวิทยาลัยราชภัฏร้อยเอ็ด","มหาวิทยาลัยราชภัฏราชนครินทร์","มหาวิทยาลัยราชภัฏรำไพพรรณี",
    "มหาวิทยาลัยราชภัฏลำปาง","มหาวิทยาลัยราชภัฏเลย","มหาวิทยาลัยราชภัฏวไลยอลงกรณ์ ในพระบรมราชูปถัมภ์",
    "มหาวิทยาลัยราชภัฏศรีสะเกษ","มหาวิทยาลัยราชภัฏสกลนคร","มหาวิทยาลัยราชภัฏสงขลา","มหาวิทยาลัยราชภัฏสวนสุนันทา",
    "มหาวิทยาลัยราชภัฏสุราษฎร์ธานี","มหาวิทยาลัยราชภัฏสุรินทร์","มหาวิทยาลัยราชภัฏหมู่บ้านจอมบึง","มหาวิทยาลัยราชภัฏอุดรธานี",
    "มหาวิทยาลัยราชภัฏอุตรดิตถ์","มหาวิทยาลัยราชภัฏอุบลราชธานี","มหาวิทยาลัยรามคำแหง","มหาวิทยาลัยวลัยลักษณ์",
    "มหาวิทยาลัยศรีนครินทรวิโรฒ","มหาวิทยาลัยศิลปากร","มหาวิทยาลัยสงขลานครินทร์","มหาวิทยาลัยสวนดุสิต",
    "มหาวิทยาลัยสุโขทัยธรรมาธิราช","มหาวิทยาลัยอุบลราชธานี","โรงงานไพ่ กรมสรรพสามิต","โรงพยาบาลขอนแก่น","โรงพยาบาลชลบุรี",
    "โรงพยาบาลบ้านแพ้ว (องค์การมหาชน)","โรงพยาบาลประสาท","โรงพยาบาลแพร่","โรงพยาบาลมหาราชนครราชสีมา",
    "โรงพยาบาลมหาราชนครศรีธรรมราช","โรงพยาบาลมะเร็งลพบุรี","โรงพยาบาลแม่สอด","โรงพยาบาลราชบุรี","โรงพยาบาลวชิระภูเก็ต",
    "โรงพยาบาลวารินชำราบ","โรงพยาบาลสระบุรี","โรงพยาบาลหาดใหญ่","โรงพยาบาลอุดรธานี",
    "โรงพิมพ์ตำรวจ สำนักงานตำรวจแห่งชาติ","โรงเรียนมหิดลวิทยานุสรณ์",
    "ศูนย์ความเป็นเลิศด้านชีววิทยาศาสตร์ (องค์การมหาชน)","ศูนย์คุณธรรม (องค์การมหาชน)","ศูนย์มานุษยวิทยาสิรินธร (องค์การมหาชน)",
    "สถาบันการบินพลเรือน","สถาบันการแพทย์ฉุกเฉินแห่งชาติ","สถาบันคุณวุฒิวิชาชีพ (องค์การมหาชน)","สถาบันคุ้มครองเงินฝาก",
    "สถาบันทดสอบทางการศึกษาแห่งชาติ (องค์การมหาชน)","สถาบันเทคโนโลยีนิวเคลียร์แห่งชาติ (องค์การมหาชน)",
    "สถาบันเทคโนโลยีป้องกันประเทศ","สถาบันเทคโนโลยีพระจอมเกล้าเจ้าคุณทหารลาดกระบัง","สถาบันนิติวิทยาศาสตร์",
    "สถาบันบริหารจัดการธนาคารที่ดิน (องค์การมหาชน)","สถาบันบัณฑิตพัฒนศิลป์","สถาบันพระปกเกล้า",
    "สถาบันพัฒนาองค์กรชุมชน (องค์การมหาชน)","สถาบันเพื่อการยุติธรรมแห่งประเทศไทย","สถาบันมาตรวิทยาแห่งชาติ",
    "สถาบันระหว่างประเทศเพื่อการค้าและการพัฒนา (องค์การมหาชน)","สถาบันรับรองคุณภาพสถานพยาบาล (องค์การมhaชน)","สถาบันวัคซีนแห่งชาติ",
    "สถาบันวิจัยดาราศาสตร์แห่งชาติ (องค์การมหาชน)","สถาบันวิจัยระบบสาธารณสุข","สถาบันวิจัยและพัฒนาเทคโนโลยีระบบราง (องค์การมหาชน)",
    "สถาบันวิจัยและพัฒนาพื้นที่สูง (องค์การมหาชน)","สถาบันวิจัยและพัฒนาอัญมณีและเครื่องประดับแห่งชาติ (องค์การมหาชน)",
    "สถาบันวิจัยวิทยาศาสตร์และเทคโนโลยีแห่งประเทศไทย","สถาบันวิจัยแสงซินโครตรอน (องค์การมหาชน)","สถาบันส่งเสริมการบริหารกิจการบ้านเมืองที่ดี",
    "สถาบันส่งเสริมการสอนวิทยาศาสตร์และเทคโนโลยี","สถาบันส่งเสริมความปลอดภัย อาชีวอนามัย และสภาพแวดล้อมในการทำงาน (องค์การมหาชน)",
    "สถาบันส่งเสริมศิลปหัตถกรรมไทย (องค์การมหาชน)","สถาบันสารสนเทศทรัพยากรน้ำ (องค์การมหาชน)","สถาบันอนุญาโตตุลาการ",
    "สภาเกษตรกรแห่งชาติ","สภาพัฒนาการเมือง","สำนักงบประมาณ","สำนักงานกองทุนน้ำมันเชื้อเพลิง","สำนักงานกองทุนสนับสนุนการสร้างเสริมสุขภาพ",
    "สำนักงานกองทุนหมู่บ้านและชุมชนเมืองแห่งชาติ","สำนักงานการตรวจเงินแผ่นดิน","สำนักงานกิจการยุติธรรม",
    "สำนักงานขับเคลื่อนการปฏิรูปประเทศ ยุทธศาสตร์ชาติและการสร้างความสามัคคีปรองดอง","สำนักงานคณะกรรมการกฤษฎีกา",
    "สำนักงานคณะกรรมการการแข่งขันทางการค้า","สำนักงานคณะกรรมการการเลือกตั้ง","สำนักงานคณะกรรมการการศึกษาขั้นพื้นฐาน",
    "สำนักงานคณะกรรมการการอาชีวศึกษา","สำนักงานคณะกรรมการการอุดมศึกษา","สำนักงานคณะกรรมการกำกับและส่งเสริมการประกอบธุรกิจประกันภัย",
    "สำนักงานคณะกรรมการข้าราชการพลเรือน","สำนักงานคณะกรรมการคุ้มครองข้อมูลส่วนบุคคล","สำนักงานคณะกรรมการคุ้มครองผู้บริโภค",
    "สำนักงานคณะกรรมการดิจิทัลเพื่อเศรษฐกิจและสังคมแห่งชาติ","สำนักงานคณะกรรมการนโยบายที่ดินแห่งชาติ","สำนักงานคณะกรรมการนโยบายรัฐวิสาหกิจ",
    "สำนักงานคณะกรรมการปฏิรูปกฎหมาย","สำนักงานคณะกรรมการป้องกันและปราบปรามการทุจริตแห่งชาติ","สำนักงานคณะกรรมการป้องกันและปราบปรามยาเสพติด",
    "สำนักงานคณะกรรมการพัฒนาระบบราชการ","สำนักงานคณะกรรมการพิเศษเพื่อประสานงานโครงการอันเนื่องมาจากพระราชดำริ",
    "สำนักงานคณะกรรมการส่งเสริมการลงทุน","สำนักงานคณะกรรมการส่งเสริมวิทยาศาสตร์ วิจัยและนวัตกรรม",
    "สำนักงานคณะกรรมการส่งเสริมสวัสดิการและสวัสดิภาพครูและบุคลากรทางการศึกษา","สำนักงานคณะกรรมการสิทธิมนุษยชนแห่งชาติ",
    "สำนักงานคณะกรรมการสุขภาพแห่งชาติ","สำนักงานคณะกรรมการอ้อยและน้ำตาลทราย",
    "สำนักงานความร่วมมือพัฒนาเศรษฐกิจกับประเทศเพื่อนบ้าน (องค์การมหาชน)","สำนักงานทรัพยากรน้ำแห่งชาติ","สำนักงานธนานุเคราะห์",
    "สำนักงานนโยบายยุทธศาสตร์การค้า","สำนักงานนโยบายและแผนการขนส่งและจราจร","สำนักงานนโยบายและแผนทรัพยากรธรรมชาติและสิ่งแวดล้อม",
    "สำนักงานนโยบายและแผนพลังงาน","สำนักงานนวัตกรรมแห่งชาติ (องค์การมหาชน)","สำนักงานบริหารและพัฒนาองค์ความรู้ (องค์การมhaชน)",
    "สำนักงานบริหารหนี้สาธารณะ","สำนักงานปฏิรูปที่ดินเพื่อเกษตรกรรม","สำนักงานประกันสังคม",
    "สำนักงานป้องกันและปราบปรามการทุจริตในภาครัฐ","สำนักงานป้องกันและปราบปรามการฟอกเงิน","สำนักงานผู้ตรวจการแผ่นดิน",
    "สำนักงานพระพุทธศาสนาแห่งชาติ","สำนักงานพัฒนาการวิจัยการเกษตร (องค์การมหาชน)","สำนักงานพัฒนาเทคโนโลยีอวกาศและภูมิสารสนเทศ (องค์การมหาชน)",
    "สำนักงานพัฒนาธุรกรรมทางอิเล็กทรอนิกส์","สำนักงานพัฒนาพิงคนคร (องค์การมหาชน)","สำนักงานพัฒนาวิทยาศาสตร์และเทคโนโลยีแห่งชาติ",
    "สำนักงานพัฒนาเศรษฐกิจจากฐานชีวภาพ (องค์การมหาชน)","สำนักงานพิพิธภัณฑ์เกษตรเฉลิมพระเกียรติพระบาทสมเด็จพระเจ้าอยู่หัว (องค์การมหาชน)",
    "สำนักงานพิมพ์คณะรัฐมนตรีและราชกิจจานุเบกษา","สำนักงานมาตรฐานผลิตภัณฑ์อุตสาหกรรม","สำนักงานมาตรฐานสินค้าเกษตรและอาหารแห่งชาติ",
    "สำนักงานรับรองมาตรฐานและประเมินคุณภาพการศึกษา (องค์การมหาชน)","สำนักงานราชบัณฑิตยสภา","สำนักงานลูกเสือแห่งชาติ",
    "สำนักงานเลขาธิการวุฒิสภา","สำนักงานเลขาธิการสภาการศึกษา","สำนักงานเลขาธิการสภาผู้แทนราษฎร","สำนักงานวิจัยแห่งชาติ",
    "สำนักงานศาลปกครอง","สำนักงานศาลยุติธรรม","สำนักงานศาลรัฐธรรมนูญ","สำนักงานศิลปวัฒนธรรมร่วมสมัย","สำนักงานเศรษฐกิจการเกษตร",
    "สำนักงานเศรษฐกิจการคลัง","สำนักงานเศรษฐกิจอุตสาหกรรม","สำนักงานส่งเสริมการจัดประชุมและนิทรรศการ (องค์การมหาชน)",
    "สำนักงานส่งเสริมวิสาหกิจขนาดกลางและขนาดย่อม","สำนักงานส่งเสริมวิสาหกิจเพื่อสังคม","สำนักงานส่งเสริมเศรษฐกิจดิจิทัล",
    "สำนักงานส่งเสริมเศรษฐกิจสร้างสรรค์ (องค์การมหาชน)","สำนักงานสถิติแห่งชาติ",
    "สำนักงานสภานโยบายการอุดมศึกษา วิทยาศาสตร์ วิจัยและนวัตกรรมแห่งชาติ","สำนักงานสภาพัฒนาการเศรษฐกิจและสังคมแห่งชาติ",
    "สำนักงานสลากกินแบ่งรัฐบาล","สำนักงานอัยการสูงสุด","สำนักนายกรัฐมนตรี","สำนักเลขาธิการคณะรัฐมนตรี","สำนักเลขาธิการนายกรัฐมนตรี",
    "หอภาพยนตร์ (องค์การมหาชน)","องค์การกระจายเสียงและแพร่ภาพสาธารณะแห่งประเทศไทย","องค์การขนส่งมวลชนกรุงเทพ",
    "องค์การคลังสินค้า","องค์การจัดการน้ำเสีย","องค์การตลาด","องค์การตลาดเพื่อเกษตรกร",
    "องค์การบริหารการพัฒนาพื้นที่พิเศษเพื่อการท่องเที่ยวอย่างยั่งยืน (องค์การมหาชน)","องค์การบริหารจัดการก๊าซเรือนกระจก (องค์การมหาชน)",
    "องค์การพิพิธภัณฑ์วิทยาศาสตร์แห่งชาติ","องค์การส่งเสริมกิจการโคนมแห่งประเทศไทย","องค์การสวนพฤกษศาสตร์","องค์การสะพานปลา",
    "องค์การสุรา","องค์การอุตสาหกรรมป่าไม้",
]


# Sector-to-service mapping with compliance and regulator info
SECTOR_DETAILS = {
    "Critical Infrastructure (CII)": {
        "key_services": [
            "Cyber Risk Assessment (IT/OT)",             # มาตรา 54
            "Tabletop Exercise (TTX)",                   # มาตรา 59
            "CIRP & Playbook",                           # มาตรา 58
            "NIST CSF Gap Assessment",                   # มาตรา 13(5)
            "Policy & Controls Baseline Readiness"       # มาตรา 43, 44, 45
        ],
        "secondary_opportunities": [
            "BCP Alignment",
            "Awareness for Executives"
        ],
        "iso27001_expected": True,
        "regulators": ["สกมช. (NCSA)"],
        "compliance_drivers": [
            "Cybersecurity Act B.E. 2562 (Sections 13(5), 43-45, 54, 58, 59)",
            "ISO/IEC 27001"
        ]
    },
    "Regulator": {
        "key_services": [
            "Cybersecurity Policy Consult",              # 43–45
            "Regulatory Gap Assessment",                 # 13(5)
            "Awareness for Regulators",
            "NIST CSF Gap Assessment (Policy & Controls)" # 43–45
        ],
        "secondary_opportunities": [
            "TTX for National Crisis",
            "Threat Intelligence Briefing"
        ],
        "iso27001_expected": False,
        "regulators": ["Self-Regulated / Government Oversight"],
        "compliance_drivers": [
            "Cybersecurity Act B.E. 2562 (Sections 13(5), 43-45)",
            "Relevant Royal Decrees",
            "Ministerial Regulations"
        ]
    },
    "Government / SOE": {
        "key_services": [
            "Cyber Risk Assessment (IT/OT)",             # มาตรา 54
            "IRP",                                       # มาตรา 58
            "TTX",                                       # มาตรา 59
            "NIST CSF Gap Assessment",                   # มาตรา 13(5)
            "Policy & Controls Baseline Readiness"       # มาตรา 43–45
        ],
        "secondary_opportunities": [
            "อว3/อช3 Consult",
            "Executive Briefing"
        ],
        "iso27001_expected": False,
        "regulators": ["สพธอ. (ETDA)", "สกมช. (NCSA)"],
        "compliance_drivers": [
            "Cybersecurity Act B.E. 2562 (Sections 13(5), 43-45, 54, 58, 59)",
            "Official Information Act B.E. 2540"
        ]
    },
    # ... (unchanged entries for other sectors)
}
SECTOR_LABELS = list(SECTOR_DETAILS.keys())

PROMPT_INSTRUCTION = f"""
You are a sector classification assistant. Your task is to categorize a company into one of the following sectors based on its name and likely business activities:
{', '.join(SECTOR_LABELS)}

Provide your answer in a JSON format with two keys: "sector" and "reason". The "reason" should be a brief explanation for your choice.

Example:
Company: "Krungthai AXA"
Output:
{{"sector": "Banking / Finance / Insurance (BFSI)", "reason": "The name contains 'Krungthai' and 'AXA', which are strongly associated with banking and insurance."}}
"""

def classify_statically(entity_name):
    """
    Performs a case-insensitive check against static lists of Thai organizations.
    Returns the sector name if a match is found, otherwise None.
    """
    name_lower = entity_name.lower()
    if any(item.lower() in name_lower for item in NCSA_CII):
        return "Critical Infrastructure (CII)"
    if any(item.lower() in name_lower for item in NCSA_REG):
        return "Regulator"
    if any(item.lower() in name_lower for item in NCSA_GOV):
        return "Government / SOE"
    return None

def get_mapped_sector_from_ai_response(ai_sector_name):
    """
    Finds the full, official sector name from the SECTOR_DETAILS keys that contains the AI's response.
    This handles cases where the AI returns a shorthand like "BFSI".
    """
    if not ai_sector_name:
        return None
        
    # First, check for an exact match (most reliable)
    if ai_sector_name in SECTOR_DETAILS:
        return ai_sector_name

    # If no exact match, check for a partial match (handles shorthand like "BFSI")
    # This makes the matching more robust.
    for key in SECTOR_DETAILS:
        if ai_sector_name.lower() in key.lower():
            return key
            
    # Return None if no match is found
    return None


def classify_with_ai(company_name):
    """
    Uses the Cohere AI model for dynamic classification and parses the result.
    Returns a tuple containing (mapped_sector, reason). Returns (None, None) on failure.
    """
    try:
        response_text = co.chat(
            model="command-r-plus",
            message=f"{PROMPT_INSTRUCTION}\nCompany: {company_name}",
            temperature=0.3
        ).text
        cleaned_json_str = re.sub(r"```json|```", "", response_text).strip()
        parsed_json = json.loads(cleaned_json_str)
        raw_ai_sector = parsed_json.get("sector", "").strip()
        
        # Map the potentially shorthand AI sector to our full sector name
        mapped_sector = get_mapped_sector_from_ai_response(raw_ai_sector)

        reason = parsed_json.get("reason", "No reason provided by AI.")
        return mapped_sector, reason
    except json.JSONDecodeError:
        st.warning(f"⚠️ AI returned a non-JSON response: '{response_text}'")
        return None, None
    except Exception as e:
        st.error(f"Error calling or parsing Cohere AI: {e}")
        return None, None

def display_unified_recommendations(sectors):
    """
    Combines recommendations from a list of sectors into a single, unified display.
    Args:
        sectors (list): A list of unique sector names to get recommendations for.
    """
    key_services = set()
    secondary_opportunities = set()
    compliance_drivers = set()
    regulators = set()

    for sector in sectors:
        if sector in SECTOR_DETAILS:
            details = SECTOR_DETAILS[sector]
            key_services.update(details.get("key_services", []))
            secondary_opportunities.update(details.get("secondary_opportunities", []))
            compliance_drivers.update(details.get("compliance_drivers", []))
            regulators.update(details.get("regulators", []))

    st.markdown("## 🌟 Unified Recommendations")
    st.markdown("Based on the combined analysis of both rule-based and AI classifications.")
    
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("### ✅ Key Services")
        if key_services:
            for svc in sorted(list(key_services)):
                st.markdown(f"- {svc}")
        else:
            st.markdown("_No specific key services found._")
            
    with col2:
        st.markdown("### 💡 Secondary Opportunities")
        if secondary_opportunities:
            for opt in sorted(list(secondary_opportunities)):
                st.markdown(f"- {opt}")
        else:
            st.markdown("_No specific secondary opportunities found._")
            
    st.markdown("---")

    col3, col4 = st.columns(2)
    with col3:
        st.markdown("### 📋 Compliance Drivers")
        if compliance_drivers:
            for law in sorted(list(compliance_drivers)):
                st.markdown(f"- {law}")
        else:
            st.markdown("_No specific compliance drivers found._")

    with col4:
        st.markdown("### 🏩 Sector Regulators")
        if regulators:
            for reg in sorted(list(regulators)):
                st.markdown(f"- {reg}")
        else:
            st.markdown("_No specific regulators found._")

# --- Streamlit UI Main Logic ---
st.set_page_config(page_title="AI Sector + Service Mapper", page_icon="🧠", layout="wide")
st.title("🧠 AI Sector Classifier + Service Recommendations")

company_input = st.text_input("🔍 Enter customer or organization name (Thai or English):", key="company_input")

if company_input:
    st.markdown("---")
    
    with st.spinner("Running classification..."):
        static_sector = classify_statically(company_input)
        ai_sector, ai_reason = classify_with_ai(company_input)

    st.markdown("## 📊 Classification Analysis")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("### 📜 Rule-Based (Official)")
        if static_sector:
            st.success(f"**{static_sector}**")
            st.caption("Matched from a predefined NCSA list.")
        else:
            st.warning("**No Match**")
            st.caption("Not found in predefined NCSA lists.")
    
    with col2:
        st.markdown("### 🤖 AI-Based (Characterization)")
        if ai_sector:
            st.info(f"**{ai_sector}**")
            st.caption(f"Reason: {ai_reason}")
        else:
            st.warning("**No AI Classification**")
            st.caption("AI could not determine a sector.")

    st.markdown("---")

    # Collect unique, valid sectors from both methods to create a single recommendation set
    final_sectors = set()
    if static_sector and static_sector in SECTOR_DETAILS:
        final_sectors.add(static_sector)
    if ai_sector and ai_sector in SECTOR_DETAILS:
        final_sectors.add(ai_sector)

    if final_sectors:
        display_unified_recommendations(list(final_sectors))
    else:
        st.error("Could not determine a valid, mapped sector from any method to provide recommendations.")
